# 2.2.6 Cycle 6: Joining and creating rooms

## Design

In this cycle, I will be making another scene that lets the player choose if they want to join an existing room or create a new one. They will be able to input an 8 character code corresponding to a room. I will achieve this by drawing two rectangles in the same place, but one slightly smaller and darker, to create the look of an input box, along with placing text on top of them which is modified through pressing keys. This scene is accessed on clicking the play button on the title screen.

If the player decides to start a new room, the server will generate a random 8 character code consisting of both upper and lowercase letters and numbers. This code will be sent back to the client who will then attempt to join using it. For now, on joining a room, the code will just be outputted in the browser console. In the next cycle, I will add a waiting screen which is shown to all players in a room before the game starts, which shows the room code, a list of players, and a start game button.

There are certain restrictions on rooms. For example, each room can only contain up to five players. Therefore, if a player attempts to join a room that has already reached its limit, the server should send an error message and the client should be prepared to handle this and inform the player there was a problem joining. Additionally, the player may type in a room code that doesn't exist. The server should be prepared for this and return an error to the client.

### Objectives

* [x] Start an instance of Socket.IO on the server and connect from the client.
* [x] Create new scene for choosing between joining or creating a room and entering room code for the former.
* [x] Draw input box with text at the front of the rectangles.
* [x] Continually check for keypresses and add any letters or numbers pressed to the text until it reaches 8 characters maximum.
* [x] If backspace is pressed, remove the last character from the text.
* [x] When join button is clicked, send an event from the client to the server containing the entered room code.
* [x] From the server-side, check for any conditions that prevent the player joining, such as the room already meeting its maximum of 5 players. If these conditions arise send an event back to the client with a brief summary of the issue (e.g. "room is full")
* [x] If no issues are encountered, join the client to the room and save user information such as the socket ID and username in a JSON object.
* [x] On joining a room, output the room code to browser console and the JSON in the server console for now.
* [x] When new room button is clicked, send an event asking to create a room.
* [x] From the server-side, continually generate an 8 character code until one not already in use is found.&#x20;
* [x] Send an event to the client with the room code, which on receiving will send back an event to the server to join the room.

### Usability Features

### Key Variables

| Variable Name | Use                                                                                                                                                                                                                                                           |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| io            | Socket.IO server.                                                                                                                                                                                                                                             |
| socket        | Client connection to Socket.IO server.                                                                                                                                                                                                                        |
| username      | Username of the client connected.                                                                                                                                                                                                                             |
| room          | Room the client is in.                                                                                                                                                                                                                                        |
| rooms         | JSON object of rooms, containing their names, information about members, and whether they have started playing.                                                                                                                                               |
| Input(x, y)   | This function draws two grey rectangles on top of each other, the second is darker and slightly smaller to give the look of an input box. It adds a third layer of white text on top and continually listens for letters and numbers to add them to the text. |

### Pseudocode

{% code title="server.js" %}
```
import socket_io

io = socket_io.createServer()

rooms = {}

io.on('connection', socket {
    let username
    let room
    
    socket.on('give username', u {
        username = u
    }
    
    socket.on('join room', r => {
        if !r in toKeys(rooms):
            socket.emit('error', "Room does not exist")
            return
        if len(rooms[r].members) == 5:
            socket.emit('error', "Room is full")
            return
        if rooms[r].started:
            socket.emit('error', "Room already started playing")
            return
            
        room = r
        
        rooms[room].members[socket.id] = {
            username: username,
            index: len(rooms[room].members),
            score: 0
        }
           
        socket.join(room)
        socket.emit('join room', room)
    }
    
    socket.on('new room', {
        chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890".split('')
        
        let r
        
        while true:
            r = ""
            
            for i in range(0, 8):
                r += random(chars)
            
            if !r in toKeys(rooms):
                break
        
        rooms[r] = {
            members: {},
            started: false
        }
        
        socket.emit('new room', room)
    })
})
```
{% endcode %}

{% code title="scenes/multiplayer.js" %}
```
func multiplayerScene() {
    add({
        text: "Enter an eight-digit room code", 
        size: 20, 
        color: grey, 
        x: centerX, 
        y: centerY - 150
    })
    
    roomInput = Input(centerX, centerY - 100)
    
    joinRoomButton = Button(centerX, centerY, "Join Room")
    
    add({
        text: "Create new room",
        y: centerY + 100,
        // Rest of properties same as other text
    })
    
    newRoomButton = Button(centerX, centerY + 150, "New Room")
    
    joinRoomButton.clicked:
        if len(roomInput.text) == 8:
            socket.emit('join room', roomInput.text)
            
    newRoomButton.clicked:
        socket.emit('new room')
        
    socket.on('join room', room {
        console.log("You joined room " + room)
    })
    
    socket.on('new room', room {
        socket.emit('join room', room)
    })
}
```
{% endcode %}

{% code title="index.js" %}
```
// If POST request to get username from session cookie is successful
success:
    socket = io.connect()
    
    socket.emit('give username, username)
```
{% endcode %}

## Development

### Outcome



### Challenges



## Testing

Evidence for testing

### Tests

<table><thead><tr><th width="95">Test</th><th width="158">Instructions</th><th width="171">What I expect</th><th width="174">What actually happens</th><th>Pass/Fail</th></tr></thead><tbody><tr><td>1</td><td>On clicking play button, go to "multiplayer" scene.</td><td>Blank screen on clicking play button (there's nothing on multiplayer scene yet).</td><td>As expected</td><td>Pass</td></tr><tr><td>2</td><td>Draw room input box and instruction text in multiplayer scene.</td><td>Input box appears below text informing player of its purpose.</td><td>As expected, but text is a little too close to input.</td><td>Pass</td></tr><tr><td>3</td><td>Move instruction text 10px further up.</td><td>Reasonable space between instruction text and input box.</td><td>As expected</td><td>Pass</td></tr><tr><td>4</td><td>Continually listen for keypresses and add any letters or numbers to room up until 8 characters. Backspace remove the last character.</td><td>When I press letters or numbers on the keyboard, they are added to the room input. When I press backspace, the last character is removed.</td><td>When I press shift alongside a letter, it does not add the uppercase letter, and adds the lowercase one instead.</td><td>Fail</td></tr><tr><td>5</td><td>Convert the letter to uppercase if the shift key is being held down.</td><td>When I hold shift down along with a letter key, the uppercase letter is added to the room input.</td><td>As expected</td><td>Pass</td></tr><tr><td>6</td><td>Add join room and new room buttons.</td><td>Button that says Join Room shows beneath input. while new room is further down the screen.</td><td>As expected</td><td>Pass</td></tr><tr><td>7</td><td>When new room is clicked, send an event to the server asking to create a new room. Once done, the server sends an event to the client with the room name.</td><td>Room name outputted to console after clicking new room.</td><td>As expected</td><td>Pass</td></tr><tr><td>8</td><td>When join room is clicked, ask the server to join the room. if checks are passed, join the client to the room and add their details to JSON, and send an event back to the client to tell them they've joined. For now the client just outputs a message to the console on receiving this event.</td><td>When I type in a room code and click join, a brief message exclaiming I joined the room along with the code is outputted to the browser console.</td><td>As expected</td><td>Pass</td></tr><tr><td>9</td><td>If the player types in a nonexistent code for joining room, display an alert telling the player the problem.</td><td>I will intentionally type in a nonexistent code and click join. A popup alert should appear in my browser telling me the room does not exist.</td><td>As expected</td><td>Pass</td></tr><tr><td>10</td><td>On receiving the room code after creating a new room, the client sends the join event to the server with that room.</td><td>When I click new room, I will automatically be joined into the room created and will see the same message in my browser console I would get if I clicked join room.</td><td>As expected</td><td>Pass</td></tr></tbody></table>

### Evidence

{% embed url="https://youtu.be/r1EqJ0qxamw" %}
Test 1: Clicking play goes to multiplayer scene, which is currently empty
{% endembed %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption><p>Test 2: Instruction text and input box rendered in multiplayer scene, but they seem a bit too close.</p></figcaption></figure>

<figure><img src="../.gitbook/assets/image (49).png" alt=""><figcaption><p>Test 3: Instruction text and input box are now a reasonable distance apart.</p></figcaption></figure>

{% embed url="https://youtu.be/QmtouNBbn7Q" %}
Test 4: Keyboard input works except capital letters.
{% endembed %}

{% embed url="https://youtu.be/lNW3f9Azei8" %}
Test 5: Capital letters now working in input
{% endembed %}

<figure><img src="../.gitbook/assets/image (47).png" alt=""><figcaption><p>Test 6: Join and New Room buttons show on screen</p></figcaption></figure>

{% embed url="https://youtu.be/ijlKYxGT3bc" %}
Test 7: Clicking New Room outputs the new room's code to the browser console
{% endembed %}

{% embed url="https://youtu.be/oYpL_uhoGFw" %}
Test 8: Joining a room outputs a message to the browser console.
{% endembed %}

{% embed url="https://youtu.be/ogctZCvd1kk" %}
Test 9: Error message if player attempts to join nonexisting room
{% endembed %}

{% embed url="https://youtu.be/IZ1ihD1e2sU" %}
Test 10: Player automatically joined into the room they created
{% endembed %}
