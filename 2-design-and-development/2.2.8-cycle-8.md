# 2.2.8 Cycle 8: World generation and rendering

## Design

In this cycle, I will be writing the server code for generating the world for each level. The world will be generated on the server to alleviate the pressure on client machines that may be less capable of performing such a task within a reasonable time period, and to allow randomly-decided aspects of the world, such as the scattering of power-up chests, to stay the same for all players in the room.

Every level will be set in a different environment and contain blocks for the road, which will be in the middle of the world, along with its surroundings. Chests and props, such as trees, will be randomly scattered in the relevant parts of the world to make the player experience feel more unique each time they play.

I will also be writing the code for the game rendering the world. Because rendering everything at once would lead to enormous amounts of lag and make the game unplayable, I have decided to only render parts of the world that fit in the game's camera. This will significantly reduce lag and make the game more efficient in terms of performance.

### Objectives

* [x] Generate the first layer of the world, this will include the block for the surroundings (e.g. grass) and for the road (e.g. dirt).
* [x] Add 1000 of specified prop (e.g. trees) on both sides of the road.
* [x] Add 300 chests to the road.
* [x] Generate four worlds with different blocks and store them in an array in the room's JSON.
* [x] Set camera position so that the road is in the middle of the screen.
* [x] Every frame, emit a Socket.IO event to the server to get the world. On the server, emit back to the client the world corresponding to their level.
* [x] Destroy all existing blocks on the game screen.
* [x] Go through each block in the world, check if they fit within the camera and render if so.

### Usability Features

### Key Variables

| Variable Name | Use |
| ------------- | --- |
|               |     |

### Pseudocode

{% code title="server.js" %}
```
func World(main, road, prop):
    world = []
    
    for y in range(0, 1000):
        for x in range(0, 20):
            world.add({
                name: x < 8 or x > 12 then: main else: road,
                x: x,
                y: y,
                z: 1
            })
            
    addProps(world, prop, 1000, 0, 7, 4)
    addProps(world, "chest", 300, 8, 12, 10)
    addProps(world, prop, 1000, 13, 20, 4)
    
    return world
    
func addProps(world, prop, amount, startX, endX, minDistance):
    for i in range(0, amount):
        x = randomBetween(startX, endX)
        y = randomBetween(0, 1000)
               
        world.add({
            name: prop,
            x: x,
            y: y,
            z: 2
        })
        
function randomBetween(start, end):
    return roundDown(random * (end - start + 1)) + start
```
{% endcode %}

{% code title="scenes/level.js" %}
```
func levelScene(levelNumber = 0):
    world = []
    
    update:
        destroyTag("block")
        
        top = (camPosY - (height / 2)) / 100
        bottom = (camPosY + (height / 2)) / 100
        left = (camPosX - (width / 2)) / 100
        right = (camPosX + (width / 2)) / 100
        
        for block in world:
            if block.x >= left and block.x <= right and block.y >= top and block.y <= bottom:
                add([
                    sprite(block.name),
                    area(),
                    pos(block.x * 100, block.y * 100),
                    z(block.z),
                    anchor("center"),
                    "block"
                ])
        
        socket.emit('load world')
        
    socket.on('load world', func (w):
        world = w
```
{% endcode %}

## Development

### Outcome



### Challenges



## Testing

Evidence for testing

### Tests

<table><thead><tr><th width="95">Test</th><th width="158">Instructions</th><th width="171">What I expect</th><th width="174">What actually happens</th><th>Pass/Fail</th></tr></thead><tbody><tr><td>1</td><td>Generate first layer of world containing road and surrounding block.</td><td>When I click start game after creating/joining a room, I see a road made of dirt in the middle of the screen surrounded by grass.</td><td>Blocks appear but empty space surrounding the view.</td><td>Fail</td></tr><tr><td>2</td><td>Extend the top, bottom, left, and right block rendering limits to allow for one block outside.</td><td>When I click start game after creating/joining a room, I see a road made of dirt in the middle of the screen surrounded by grass.</td><td>As expected</td><td>Pass</td></tr><tr><td>3</td><td>Randomly add 1000 of specified prop to each side of the road.</td><td>Trees to both sides of the road on the grass.</td><td>As expected</td><td>Pass</td></tr><tr><td>4</td><td>Randomly add 300 of specified prop to each side of the road.</td><td>Chests on the road itself.</td><td>As expected</td><td>Pass</td></tr></tbody></table>

### Evidence

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption><p>Test 1: Road and surroundings rendered but there is empty space around the view.</p></figcaption></figure>

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption><p>Test 2: All blocks of world within the view of the camera rendered on-screen</p></figcaption></figure>

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption><p>Test 3: Trees to both sides of the road</p></figcaption></figure>

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption><p>Test 4: Chests on the road itself</p></figcaption></figure>
