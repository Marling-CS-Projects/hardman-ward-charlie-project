# 2.2.8 Cycle 8: World generation and rendering

## Design

In this cycle, I will be writing the server code for generating the world for each level. The world will be generated on the server to alleviate the pressure on client machines that may be less capable of performing such a task within a reasonable time period, and to allow randomly-decided aspects of the world, such as the scattering of power-up chests, to stay the same for all players in the room.

Every level will be set in a different environment and contain blocks for the road, which will be in the middle of the world, along with its surroundings. Chests and props, such as trees, will be randomly scattered in the relevant parts of the world to make the player experience feel more unique each time they play.

I will also be writing the code for the game rendering the world. Because rendering everything at once would lead to enormous amounts of lag and make the game unplayable, I have decided to only render parts of the world that fit in the game's camera. This will significantly reduce lag and make the game more efficient in terms of performance.

### Objectives

* [x] Generate the first layer of the world, this will include the block for the surroundings (e.g. grass) and for the road (e.g. dirt).
* [x] Add 1000 of specified prop (e.g. trees) on both sides of the road.
* [x] Make sure each prop is a certain distance from one another.
* [x] Add 300 chests to the road, once again keeping a distance to prevent clusters.
* [x] Generate four worlds with different blocks and store them in an array in the room's JSON.
* [x] Set camera position so that the road is in the middle of the screen.
* [x] Every frame, emit a Socket.IO event to the server to get the world. On the server, emit back to the client the world corresponding to their level.
* [x] Destroy all existing blocks on the game screen.
* [x] Go through each block in the world, check if they fit within the camera and if so render them.

### Usability Features

### Key Variables

| Variable Name | Use |
| ------------- | --- |
|               |     |

### Pseudocode

{% code title="server.js" %}
```
func World(main, road, prop):
    world = []
    
    for y in range(0, 1000):
        for x in range(0, 20):
            world.add({
                name: x < 8 or x > 12 then: main else: road,
                x: x,
                y: y,
                z: 1
            })
            
    addProps(world, prop, 1000, 0, 7, 4)
    addProps(world, "chest", 300, 8, 12, 10)
    addProps(world, prop, 1000, 13, 20, 4)
    
    return world
    
func addProps(world, prop, amount, startX, endX, minDistance):
    rangeX = endX - startX
    
    positions = []
    
    for i in range(0, amount):
        while true:
            x = random(rangeX) + startX
            y = random(1000)
            
            if !isPropTooClose(positions, x, y, minDistance):
                break
                
        world.add({
            name: prop,
            x: x,
            y: y,
            z: 2
        })
        
        positions.push({
            x: x,
            y: y
        })
        
func isPropTooClose(positions, x, y, minDistance):
    for position in positions:
        diffX = position.x - x
        diffY = position.y - y
        
        distance = squareRoot(diffX ^ 2 + diffY ^ 2)
        
        if distance < minDistance:
            return true
            
    return false
```
{% endcode %}

{% code title="scenes/level.js" %}
```
func levelScene(levelNumber default 0):
    update:
        socket.emit('load world')
        
    socket.on('load world', func (world):
        destroyTag("block")
        
        top = (camPosY - (height / 2)) / 100
        bottom = (camPosY + (height / 2)) / 100
        left = (camPosX - (width / 2)) / 100
        right = (camPosX + (width / 2)) / 100
        
        for block in world:
            if block.x >= left and block.x <= right and block.y >= top and block.y <= bottom:
                add([
                    sprite(block.name),
                    area(),
                    pos(block.x * 100, block.y * 100),
                    z(block.z),
                    anchor("center"),
                    "block"
                ])
```
{% endcode %}

## Development

### Outcome



### Challenges



## Testing

Evidence for testing

### Tests

<table><thead><tr><th width="95">Test</th><th width="158">Instructions</th><th width="171">What I expect</th><th width="174">What actually happens</th><th>Pass/Fail</th></tr></thead><tbody><tr><td>1</td><td>Generate first layer of world containing road and surrounding block.</td><td>When I click start game after creating/joining a room, I see a road made of dirt in the middle of the screen surrounded by grass.</td><td>As expected</td><td>Pass</td></tr><tr><td>2</td><td>Add 1000 of prop to each side of road with a small distance between them.</td><td>Trees appear on each side of the road on the grass, distanced apart from one another. </td><td>Trees appear on each side of the road but they are not spaced apart.</td><td>Fail</td></tr><tr><td>3</td><td>Change isPropTooClose function to use for loop instead of foreach function of array to go through each prop position.</td><td>Trees appear on each side of the road on the grass, distanced apart from one another. </td><td>Game hangs creating a new room.</td><td>Fail</td></tr><tr><td>4</td><td>Replace while loop in addProps function with recursive function that repeats if the generated co-ordinates are too close to other props.</td><td>Trees appear on each side of the road on the grass, distanced apart from one another. </td><td>As expected</td><td>Pass</td></tr><tr><td>5</td><td>Add 300 chests to the road itself with a distance between them.</td><td>Chests appear scattered across the dirt road.</td><td>As expected</td><td>Pass</td></tr></tbody></table>

### Evidence

{% embed url="https://youtu.be/lJOXBP2OLzE" %}
Test 1: Dirt road in middle of the world and screen surrounded by grass
{% endembed %}

{% embed url="https://youtu.be/tVOIKef3mEg" %}
Test 2: Trees scattered across grass surroundings but not with distance between
{% endembed %}

{% embed url="https://youtu.be/1d_NNxifMCo" %}
Test 3: Server hangs generating world when client clicks new room
{% endembed %}

{% embed url="https://youtu.be/bhFouSGCGm4" %}
Test 4: Trees appear to the sides of road with distance between them
{% endembed %}

{% embed url="https://youtu.be/31GN6IezOyw" %}
Test 5: Chest in the road
{% endembed %}
