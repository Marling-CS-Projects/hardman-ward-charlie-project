# 2.2.21 Cycle 21: Level leaderboard

## Design

In this cycle, I will be writing the code for the leaderboard that shows after all players have completed a race. It will display each player's position in that race, how many points they gained, and their overall standing position. After ten seconds, any player can click a button to move onto the next level.

### Objectives

* [x] Leaderboard displays after each level showing players ordered by when they finished.
* [x] After five seconds game goes onto the next level.
* [x] Player gets points based on how they did.

### Usability Features

* User interface -> Leaderboard.

### Key Variables

| Variable Name | Use |
| ------------- | --- |
|               |     |

### Pseudocode

```
```

## Development

### Outcome

After finishing this cycle, I have added leaderboards shown at the end of each level which display how players performed ranked by how soon they finished. Additionally, I have implemented a transition between levels which takes place after five seconds of the leaderboard being shown, which I view as a reasonable amount of time for the player to see their progress.

Firstly, in [Cycle 12](2.2.12-cycle-12.md) to end the stopwatch after finishing, I had to dispatch a custom JavaScript event that could be handled from a point in the code where the timeout was accessible. To detect when the player crosses the finish line, I have added another listener for this event this time in the level scene. When this listener is triggered, the game gets the player's position from the position indicator and sends a Socket.IO event to the server saying they have finished along with their position.

{% code title="public/scenes/level.js" %}
```javascript
let finished = false

window.addEventListener('finish', () => {
    if (!finished) {
        socket.emit('finish', parseInt(positionIndicator.text) - 1)

        finished = true
    }
})
```
{% endcode %}

When the server receives this event, it creates a leaderboard array for that level if it doesn't already exist. It then uses the position to determine how many points the player got for that level, with 1st place getting 10 points, 2nd place getting 5, and so on. The username of the player and new points is pushed to the leaderboard for that level.

{% code title="server.js" %}
```javascript
socket.on('finish', position => {
    if (!rooms[room].leaderboards[level]) {
        rooms[room].leaderboards[level] = []
    }

    const points = [10, 5, 4, 2, 0]

    rooms[room].leaderboards[level].push({
        username: username,
        points: points[position]
    })
```
{% endcode %}

Secondly, once all players have finished, the game should then progress onto the leaderboard. Whenever a player finishes, the server compares the number of members of the room to the number of players who have finished. If they are the same, an event is broadcasted to all clients telling them to go to the leaderboard.

{% code title="server.js" %}
```javascript
const totalPlayers = Object.keys(rooms[room].members).length
const finishedPlayers = Object.keys(rooms[room].leaderboards[level]).length

if (totalPlayers == finishedPlayers) {
    io.to(room).emit('go to leaderboard')
}
```
{% endcode %}

{% code title="public/scenes/level.js" %}
```javascript
socket.on('go to leaderboard', () => {
    go("leaderboard")
})
```
{% endcode %}

Thirdly, I have created a new scene for the level leaderboard. It has the text "Leaderboard" in large at the top of the screen. Three text sprites are added for position, username, and new points; these will serve as columns for the data of the leaderboard.

{% code title="public/scenes/leaderboard.js" %}
```javascript
function leaderboardScene() { 
    socket.off()

    add([
        text("Leaderboard", { size: 72 }),
        color(160, 160, 160),
        area(),
        fixed(),
        anchor("top"),
        pos(center().x, 10)
    ])

    const positionText = add([
        text("Position\n", { size: 20 }),
        color(255, 255, 255),
        area(),
        fixed(),
        z(2),
        anchor("center"),
        pos(center().x - 150, center().y)
    ])

    const usernameText = add([
        text("Username\n", { size: 20 }),
        color(255, 255, 255),
        area(),
        fixed(),
        z(2),
        anchor("center"),
        pos(center())
    ])

    const pointsText = add([
        text("New Points\n", { size: 20 }),
        color(255, 255, 255),
        area(),
        fixed(),
        z(2),
        anchor("center"),
        pos(center().x + 150, center().y)
    ])
```
{% endcode %}

Fourthly, the game in the leaderboard scene sends a request to the server for the leaderboard information, which returns the leaderboard array for the level. After five seconds, it checks what level the player was on. If they were on level 4, the server will send an event back to the client telling them to move to the final leaderboard; for now this does nothing. Otherwise, the level is incremented and an event is sent telling them to go onto the next level.

{% code title="server.js" %}
```javascript
socket.on('get leaderboard', () => {
    socket.emit('get leaderboard', rooms[room].leaderboards[level])

    setTimeout(() => {
        if (level == 3) {
            socket.emit('go to final leaderboard')
        } else {
            level++
            socket.emit('next level')
        }
    }, 5000)
})
```
{% endcode %}

{% code title="public/scenes/leaderboard.js" %}
```javascript
socket.emit('get leaderboard')
```
{% endcode %}

When the server has responded to the re

### Challenges



## Testing

Evidence for testing

### Tests

<table><thead><tr><th width="95">Test</th><th width="158">Instructions</th><th width="171">What I expect</th><th width="174">What actually happens</th><th>Pass/Fail</th></tr></thead><tbody><tr><td>1</td><td>After all players finish a level, display leaderboard.</td><td>Leaderboard shows with players ranked by how they finished.</td><td>TypeError: cannot set properties of undefined (setting 'angle')</td><td>Pass</td></tr><tr><td>2</td><td>Remove all Socket.IO listeners at the start of the leaderboard scene.</td><td>Leaderboard shows with players ranked by how they finished.</td><td>As expected</td><td>Pass</td></tr><tr><td>3</td><td>After five seconds of the leaderboard go onto the next level.</td><td>Next level loads after five seconds of being on the leaderboard.</td><td>As expected</td><td>Pass</td></tr></tbody></table>

### Evidence

{% embed url="https://youtu.be/HyI-PH3PTpI" %}
Test 1: TypeError when going to leaderboard
{% endembed %}

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption><p>Test 1: The TypeError</p></figcaption></figure>

{% embed url="https://youtu.be/3oXrcSX_PTo" %}
Test 2 and 3: Leaderboard shows after level, goes to next after five seconds
{% endembed %}
