# 2.2.3 Cycle 3: User authentication and login

## Design

In this cycle, I will complete the login system by writing the code for handling submissions of the login form. This will compare the password submitted in the login form to the hash stored in the users table of the database and, if they match, generate a UUIDv4 code which will be written to the sessions table and stored as a browser cookie as a way of showing the user is signed in. This is preferrable to simply storing the username in a cookie because cookies can be altered by the client, which could lead to user impersonation if I just store the username. A UUID assigned to a user is much harder to guess.

### Objectives

* [x] Get username and password submitted by user.
* [x] Use a SQL query to get the first entry of the users table with the username submitted. If there is none, send back 401 (unauthorised) error and halt further execution.
* [x] Get the hashed password from the results of the SQL query.
* [x] Compare the submitted password with the hashed password. If they do not match, send back same error as before.
* [x] Generate a UUIDv4 code for session.
* [x] Write session to sessions table of database alongside the username.
* [x] Save session as a browser cookie.
* [x] Send message back to client saying login was successful.
* [x] Change the behaviour of registration to reload the page in the event of a successful registration, because the login and registration forms are accessible on the same page.

### Usability Features

### Key Variables

| Variable Name | Use                                                                                                  |
| ------------- | ---------------------------------------------------------------------------------------------------- |
| entry         | Result for SQL query for entry with username sent in form.                                           |
| hash          | Hashed password from SQL query for username. Used to check if password submitted by user is correct. |
| session       | UUIDv4 saved in cookie that will be used to identify the user.                                       |

### Pseudocode

{% code title="app.js" %}
```
import uuidv4

app.post('/sign-in', func async (req, res) {
    username, password = req.body
    
    db = await openDatabase()
    
    entry = db.get("SELECT * FROM users WHERE username = ?", username)
    
    if !entry {
        res.errorCode(401).message("Incorrect username or password")
        return
    }
    
    hash = entry.password
    
    password_correct = bcrypt.compare(plaintext=password, hashed=hash)
    
    if !password_correct {
        res.errorCode(401).message("Incorrect username or password")
        return
    }
    
    session = uuidv4()
    
    db.run("INSERT INTO sessions (session, username) VALUES (?, ?)", [session, username])
    db.close()
    
    res.save_cookie('session', session)
    res.message("Login successful")
})

app.post('/sign-up', func async (req, res) {
    // Other code
    
    res.reload()
})
```
{% endcode %}

## Development

### Outcome



### Challenges



## Testing

Evidence for testing

### Tests

<table><thead><tr><th width="95">Test</th><th width="158">Instructions</th><th width="171">What I expect</th><th width="174">What actually happens</th><th>Pass/Fail</th></tr></thead><tbody><tr><td>1</td><td>Query entry from users table where username matches one submitted by user, and output to server console.</td><td>JSON object with database query values is outputted to  server console.</td><td>As expected</td><td>Pass</td></tr><tr><td>2</td><td>Display error message to client if they enter a nonexistent username.</td><td>When I submit a username that doesn't exist, I get an error saying the username or password I entered was incorrect.</td><td>As expected</td><td>Pass</td></tr><tr><td>3</td><td>Display error message to client if they enter an existing username but the wrong password.</td><td>When I attempt to sign in with my "charlie" account created in the previous cycle, but deliberately enter the wrong password, I get the same message as before.</td><td>Server crashes and console displays: Uncaught Error Error: data and hash arguments required.</td><td>Fail</td></tr><tr><td>4</td><td>Get password property of JSON object rather than nonexistent "hash" property when storing hash variable.</td><td>When I attempt to sign in with my "charlie" account created in the previous cycle, but deliberately enter the wrong password, I get the same message as before.</td><td>As expected</td><td>Pass</td></tr><tr><td>5</td><td>Generate UUIDv4 as session and write entry to sessions table with session and username.</td><td>New entry in sessions table with UUID and username after submitting form.</td><td>As expected</td><td>Pass</td></tr><tr><td>6</td><td>Store session in browser cookie.</td><td>Session accessible from browser console by entering "document.cookie"</td><td>As expected</td><td>Pass</td></tr><tr><td>7</td><td>Show message saying login was successful if no issues occured.</td><td>Page saying login successful shown after submitting form.</td><td>As expected</td><td>Pass</td></tr></tbody></table>

### Evidence

<figure><img src="../.gitbook/assets/image (10).png" alt=""><figcaption><p>Test 1: JSON object with database query result values outputted to console.</p></figcaption></figure>

{% embed url="https://youtu.be/8txcyuoa__Q" %}
Test 2: When I attempt to sign in with a nonexistent username, I get an error saying my details are incorrect
{% endembed %}

{% embed url="https://youtu.be/XyrKb1l4l88" %}
Test 3: Server crashes when I submit wrong password.&#x20;
{% endembed %}

<figure><img src="../.gitbook/assets/image (11).png" alt=""><figcaption><p>Test 3: Uncaught Error Error: data and hash arguments required.</p></figcaption></figure>

{% embed url="https://youtu.be/Y1AZSe9Z7QA" %}
Test 4: When I attempt to sign in with the wrong password, I get the same error about my details being incorrect
{% endembed %}

<figure><img src="../.gitbook/assets/image (12).png" alt=""><figcaption><p>Test 5: Entry written to sessions table with UUIDv4 and username.</p></figcaption></figure>

<figure><img src="../.gitbook/assets/image (13).png" alt=""><figcaption><p>Test 6: Session stored in browser cookie after signing in.</p></figcaption></figure>

{% embed url="https://youtu.be/AcmjSy91vZs" %}
Test 7: Message shown in browser if sign-in is successful.
{% endembed %}

{% embed url="https://youtu.be/2HUxB0KhH_g" %}
Test 8: The page is refreshed after I submit the sign up form
{% endembed %}
