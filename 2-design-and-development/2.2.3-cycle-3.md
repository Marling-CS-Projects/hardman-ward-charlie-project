# 2.2.3 Cycle 3: User authentication and login

## Design

In this cycle, I will complete the login system by writing the code for handling submissions of the login form. This will compare the password submitted in the login form to the hash stored in the users table of the database and, if they match, generate a UUIDv4 code which will be written to the sessions table and stored as a browser cookie as a way of showing the user is signed in. This is preferrable to simply storing the username in a cookie because cookies can be altered by the client, which could lead to user impersonation if I just store the username. A UUID assigned to a user is much harder to guess.

### Objectives

* [x] Send credentials to the server with a POST request.
* [x] If the username does not exist, display an error.
* [x] If the given password does not match the hash, display the same error.
* [x] Generate a session in format UUIDv4.
* [x] Write an entry with the session and username to the sessions table.
* [x] Save session as browser cookie.

### Usability Features

### Key Variables

| Variable Name | Use                                                                                                  |
| ------------- | ---------------------------------------------------------------------------------------------------- |
| entry         | Result for SQL query for entry with username sent in form.                                           |
| hash          | Hashed password from SQL query for username. Used to check if password submitted by user is correct. |
| session       | UUIDv4 saved in cookie that will be used to identify the user.                                       |

### Pseudocode

{% code title="app.js" %}
```
import uuidv4

app.post('/sign-in', func async (req, res) {
    username, password = req.body
    
    db = await openDatabase()
    
    entry = db.get("SELECT * FROM users WHERE username = ?", username)
    
    if !entry {
        res.errorCode(401).message("Incorrect username or password")
        return
    }
    
    hash = entry.password
    
    password_correct = bcrypt.compare(plaintext=password, hashed=hash)
    
    if !password_correct {
        res.errorCode(401).message("Incorrect username or password")
        return
    }
    
    session = uuidv4()
    
    db.run("INSERT INTO sessions (session, username) VALUES (?, ?)", [session, username])
    db.close()
    
    res.save_cookie('session', session)
    res.message("Login successful")
})

app.post('/sign-up', func async (req, res) {
    // Other code
    
    res.reload()
})
```
{% endcode %}

## Development

### Outcome



### Challenges



## Testing

Evidence for testing

### Tests

<table><thead><tr><th width="95">Test</th><th width="158">Instructions</th><th width="171">What I expect</th><th width="174">What actually happens</th><th>Pass/Fail</th></tr></thead><tbody><tr><td>1</td><td>Print to server console the contents of entry from users table corresponding to given username.</td><td>Username and password of account printed to server console after submitting form.</td><td>As expected</td><td>Pass</td></tr><tr><td>2</td><td>If the entry is empty, display an error message in the browser.</td><td>If the username entered in the login form doesn't exist, an error will be displayed in the browser.</td><td>As expected</td><td>Pass</td></tr><tr><td>3</td><td>If the given password does not match the hash, display an error message in the browser.</td><td>If the username exists but the password is incorrect, an error will be displayed in the browser.</td><td>Server crashes and console displays: Uncaught Error Error: data and hash arguments required.</td><td>Fail</td></tr><tr><td>4</td><td>Update code to store password property of entry as hash instead of nonexistent "hash" property.</td><td>If the username exists but the password is incorrect, an error will be displayed in the browser.</td><td>As expected</td><td>Pass</td></tr><tr><td>5</td><td>Generate UUIDv4 and write entry to sessions table.</td><td>After signing in, a new entry is written to the sessions table containing UUIDv4 and username.</td><td>As expected</td><td>Pass</td></tr><tr><td>6</td><td>Store session in browser cookie.</td><td>Session value stored in browser cookie.</td><td>As expected</td><td>Pass</td></tr><tr><td>7</td><td>Display success message in browser if login succeeded. </td><td>Message saying the login successful after signing in.</td><td>As expected</td><td>Pass</td></tr></tbody></table>

### Evidence

<figure><img src="../.gitbook/assets/image (10).png" alt=""><figcaption><p>Test 1: JSON object with database query result values outputted to console.</p></figcaption></figure>

{% embed url="https://youtu.be/8txcyuoa__Q" %}
Test 2: When I attempt to sign in with a nonexistent username, I get an error saying my details are incorrect
{% endembed %}

{% embed url="https://youtu.be/XyrKb1l4l88" %}
Test 3: Server crashes when I submit wrong password.&#x20;
{% endembed %}

<figure><img src="../.gitbook/assets/image (11).png" alt=""><figcaption><p>Test 3: Uncaught Error Error: data and hash arguments required.</p></figcaption></figure>

{% embed url="https://youtu.be/Y1AZSe9Z7QA" %}
Test 4: When I attempt to sign in with the wrong password, I get the same error about my details being incorrect
{% endembed %}

<figure><img src="../.gitbook/assets/image (12).png" alt=""><figcaption><p>Test 5: Entry written to sessions table with UUIDv4 and username.</p></figcaption></figure>

<figure><img src="../.gitbook/assets/image (13).png" alt=""><figcaption><p>Test 6: Session stored in browser cookie after signing in.</p></figcaption></figure>

{% embed url="https://youtu.be/AcmjSy91vZs" %}
Test 7: Message shown in browser if sign-in is successful.
{% endembed %}

{% embed url="https://youtu.be/2HUxB0KhH_g" %}
Test 8: The page is refreshed after I submit the sign up form
{% endembed %}
